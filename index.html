<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>å•†å“çµ„ã¿åˆã‚ã›æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family:
                    "Segoe UI", "Hiragino Sans", "Noto Sans JP", sans-serif;
                background: #f0f2f5;
                color: #333;
                min-height: 100vh;
            }

            .header {
                background: linear-gradient(135deg, #4a6cf7, #6a3de8);
                color: #fff;
                padding: 28px 20px;
                text-align: center;
            }
            .header h1 {
                font-size: 1.6rem;
                letter-spacing: 0.05em;
            }
            .header p {
                margin-top: 6px;
                font-size: 0.85rem;
                opacity: 0.85;
            }

            .container {
                max-width: 960px;
                margin: 0 auto;
                padding: 20px;
            }

            .card {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
                padding: 24px;
                margin-bottom: 20px;
            }
            .card h2 {
                font-size: 1.1rem;
                margin-bottom: 14px;
                padding-bottom: 8px;
                border-bottom: 2px solid #4a6cf7;
                color: #4a6cf7;
            }

            .drop-zone {
                border: 2px dashed #aab;
                border-radius: 10px;
                padding: 30px;
                text-align: center;
                color: #888;
                transition: all 0.2s;
                cursor: pointer;
                margin-bottom: 12px;
            }
            .drop-zone:hover,
            .drop-zone.drag-over {
                border-color: #4a6cf7;
                background: #f5f6ff;
                color: #4a6cf7;
            }
            .drop-zone .icon {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            .drop-zone p {
                font-size: 0.9rem;
            }

            .file-controls {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
                margin-bottom: 12px;
            }
            .file-controls .btn {
                padding: 8px 18px;
                font-size: 0.85rem;
                font-weight: 600;
                border: 2px solid #4a6cf7;
                border-radius: 8px;
                cursor: pointer;
                background: #fff;
                color: #4a6cf7;
                transition: all 0.2s;
            }
            .file-controls .btn:hover {
                background: #4a6cf7;
                color: #fff;
            }
            .file-controls .btn.sample {
                border-color: #28a745;
                color: #28a745;
            }
            .file-controls .btn.sample:hover {
                background: #28a745;
                color: #fff;
            }
            .file-controls .btn.danger {
                border-color: #dc3545;
                color: #dc3545;
            }
            .file-controls .btn.danger:hover {
                background: #dc3545;
                color: #fff;
            }
            .file-controls select {
                padding: 8px 12px;
                border: 2px solid #ccc;
                border-radius: 8px;
                font-size: 0.85rem;
            }

            .server-banner {
                padding: 10px 16px;
                border-radius: 8px;
                font-size: 0.85rem;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .server-banner.loading {
                background: #fff3cd;
                color: #856404;
            }
            .server-banner.success {
                background: #d4edda;
                color: #155724;
            }
            .server-banner.fail {
                background: #f8d7da;
                color: #721c24;
            }
            .server-banner .mini-spinner {
                width: 14px;
                height: 14px;
                border: 2px solid #856404;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 0.6s linear infinite;
            }

            .category-list {
                max-height: 520px;
                overflow-y: auto;
            }
            .category-panel {
                border: 1px solid #dde0f5;
                border-radius: 8px;
                margin-bottom: 8px;
                overflow: hidden;
            }
            .category-header {
                display: flex;
                align-items: center;
                padding: 10px 14px;
                background: #f8f9ff;
                cursor: pointer;
                gap: 8px;
                user-select: none;
            }
            .category-header:hover {
                background: #edefff;
            }
            .category-header .cat-cb {
                flex-shrink: 0;
                width: 18px;
                height: 18px;
                cursor: pointer;
            }
            .category-header .cat-name {
                font-weight: 700;
                flex: 1;
            }
            .category-header .cat-count {
                font-size: 0.8rem;
                color: #888;
                margin-right: 8px;
            }
            .category-header .cat-toggle {
                font-size: 0.75rem;
                color: #999;
                transition: transform 0.2s;
            }
            .category-header .cat-toggle.open {
                transform: rotate(180deg);
            }

            .category-body {
                display: none;
                padding: 4px 14px 10px 40px;
            }
            .category-body.expanded {
                display: block;
            }

            .product-row {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 5px 0;
                border-bottom: 1px solid #f0f0f0;
                font-size: 0.88rem;
            }
            .product-row:last-child {
                border-bottom: none;
            }
            .product-row input[type="checkbox"] {
                width: 16px;
                height: 16px;
                cursor: pointer;
                flex-shrink: 0;
            }
            .product-row .prod-name {
                flex: 1;
            }
            .product-row .prod-price {
                color: #4a6cf7;
                font-weight: 600;
                white-space: nowrap;
            }

            .no-data {
                text-align: center;
                color: #999;
                padding: 30px;
                font-size: 0.95rem;
            }

            .cb-actions {
                display: flex;
                gap: 8px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            }
            .cb-actions .btn-sm {
                padding: 5px 14px;
                font-size: 0.8rem;
                border-radius: 6px;
                border: 1px solid #aab;
                background: #fff;
                cursor: pointer;
                transition: all 0.2s;
            }
            .cb-actions .btn-sm:hover {
                background: #eee;
            }

            .product-summary {
                font-size: 0.85rem;
                color: #666;
                margin-bottom: 10px;
            }

            .input-row {
                display: flex;
                gap: 12px;
                align-items: center;
                flex-wrap: wrap;
            }
            .input-row label {
                font-weight: 600;
                white-space: nowrap;
            }
            .input-row input[type="number"] {
                width: 180px;
                padding: 10px 14px;
                font-size: 1rem;
                border: 2px solid #ccc;
                border-radius: 8px;
                outline: none;
                transition: border 0.2s;
            }
            .input-row input[type="number"]:focus {
                border-color: #4a6cf7;
            }

            .btn-calc {
                padding: 10px 28px;
                font-size: 1rem;
                font-weight: 600;
                color: #fff;
                background: linear-gradient(135deg, #4a6cf7, #6a3de8);
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .btn-calc:hover {
                opacity: 0.85;
            }
            .btn-calc:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .err-msg {
                color: #d32f2f;
                font-size: 0.85rem;
                margin-top: 8px;
            }

            .status-bar {
                padding: 14px 18px;
                border-radius: 8px;
                font-size: 0.95rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .status-bar.idle {
                background: #e9ecef;
                color: #666;
            }
            .status-bar.running {
                background: #fff3cd;
                color: #856404;
            }
            .status-bar.done {
                background: #d4edda;
                color: #155724;
            }
            .status-bar.error {
                background: #f8d7da;
                color: #721c24;
            }
            .status-bar.warn {
                background: #fff3cd;
                color: #856404;
            }

            .spinner {
                width: 18px;
                height: 18px;
                border: 3px solid #856404;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 0.6s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .sort-controls {
                display: flex;
                align-items: center;
                gap: 10px;
                margin: 12px 0 6px;
                flex-wrap: wrap;
            }
            .sort-controls label {
                font-size: 0.85rem;
                font-weight: 600;
                color: #555;
            }
            .sort-btn {
                padding: 6px 16px;
                font-size: 0.82rem;
                font-weight: 600;
                border: 2px solid #ccc;
                border-radius: 6px;
                background: #fff;
                cursor: pointer;
                transition: all 0.15s;
                color: #555;
            }
            .sort-btn:hover {
                border-color: #4a6cf7;
                color: #4a6cf7;
            }
            .sort-btn.active {
                border-color: #4a6cf7;
                background: #4a6cf7;
                color: #fff;
            }

            .result-list {
                max-height: 500px;
                overflow-y: auto;
                padding: 4px 0;
            }
            .result-item {
                padding: 10px 16px;
                border-bottom: 1px solid #eee;
                font-size: 0.9rem;
                line-height: 1.5;
                display: flex;
                align-items: baseline;
                gap: 8px;
            }
            .result-item:last-child {
                border-bottom: none;
            }
            .result-item .idx {
                display: inline-block;
                background: #4a6cf7;
                color: #fff;
                border-radius: 4px;
                padding: 1px 8px;
                font-size: 0.78rem;
                font-weight: 600;
                flex-shrink: 0;
            }
            .result-item .combo-detail {
                flex: 1;
            }
            .result-item .item-count {
                font-size: 0.78rem;
                color: #888;
                white-space: nowrap;
                flex-shrink: 0;
                margin-left: auto;
            }

            ::-webkit-scrollbar {
                width: 6px;
            }
            ::-webkit-scrollbar-thumb {
                background: #bbb;
                border-radius: 3px;
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ğŸ›’ å•†å“çµ„ã¿åˆã‚ã›æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>
                CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å•†å“ã‚’èª­ã¿è¾¼ã¿ã€ç›®æ¨™é‡‘é¡ã´ã£ãŸã‚Šã®çµ„ã¿åˆã‚ã›ã‚’å…¨æ¢ç´¢ã—ã¾ã™
            </p>
        </div>

        <div class="container">
            <div class="card">
                <h2>ğŸ“‚ CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</h2>
                <div
                    id="serverBanner"
                    class="server-banner loading"
                    style="display: none"
                ></div>
                <div
                    class="drop-zone"
                    id="dropZone"
                    onclick="document.getElementById('dirInput').click()"
                >
                    <div class="icon">ğŸ“</div>
                    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p style="font-size: 0.8rem; margin-top: 4px">
                        ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ï¼ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠ
                    </p>
                </div>
                <div class="file-controls">
                    <button
                        class="btn"
                        onclick="document.getElementById('dirInput').click()"
                    >
                        ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
                    </button>
                    <button
                        class="btn"
                        onclick="document.getElementById('fileInput').click()"
                    >
                        ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                    </button>
                    <button class="btn" onclick="reloadFromServer()">
                        ğŸ”„ ã‚µãƒ¼ãƒãƒ¼å†èª­è¾¼
                    </button>
                    <button class="btn sample" onclick="loadSampleData()">
                        ğŸ’¡ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
                    </button>
                    <button class="btn danger" onclick="clearAllData()">
                        ğŸ—‘ ã‚¯ãƒªã‚¢
                    </button>
                    <label style="font-size: 0.85rem; color: #666"
                        >æ–‡å­—ã‚³ãƒ¼ãƒ‰:</label
                    >
                    <select id="encoding">
                        <option value="UTF-8">UTF-8</option>
                        <option value="Shift_JIS">Shift-JIS</option>
                    </select>
                </div>
                <input
                    type="file"
                    id="dirInput"
                    webkitdirectory
                    style="display: none"
                />
                <input
                    type="file"
                    id="fileInput"
                    multiple
                    accept=".csv"
                    style="display: none"
                />
                <div id="loadMsg" style="font-size: 0.85rem; color: #666"></div>
            </div>

            <div class="card">
                <h2>ğŸ“¦ å•†å“ãƒªã‚¹ãƒˆ</h2>
                <div id="productSummary" class="product-summary"></div>
                <div class="cb-actions" id="cbActions" style="display: none">
                    <button class="btn-sm" onclick="selectAll(true)">
                        âœ… å…¨é¸æŠ
                    </button>
                    <button class="btn-sm" onclick="selectAll(false)">
                        â¬œ å…¨è§£é™¤
                    </button>
                    <button class="btn-sm" onclick="toggleExpandAll(true)">
                        ğŸ”½ å…¨ã¦å±•é–‹
                    </button>
                    <button class="btn-sm" onclick="toggleExpandAll(false)">
                        ğŸ”¼ å…¨ã¦æŠ˜ç•³
                    </button>
                </div>
                <div class="category-list" id="categoryList">
                    <div class="no-data" id="noData">
                        CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ” æ¤œç´¢æ¡ä»¶</h2>
                <div class="input-row">
                    <label for="target">ç›®æ¨™é‡‘é¡ï¼ˆå††ï¼‰:</label>
                    <input
                        type="number"
                        id="target"
                        min="1"
                        value="1000"
                        placeholder="ä¾‹: 1000"
                    />
                    <button
                        class="btn-calc"
                        id="btnCalc"
                        onclick="startSearch()"
                    >
                        è¨ˆç®—ã™ã‚‹
                    </button>
                </div>
                <div id="errMsg" class="err-msg"></div>
            </div>

            <div class="card">
                <h2>ğŸ“Š çµæœ</h2>
                <div id="statusBar" class="status-bar idle">
                    å•†å“ã‚’èª­ã¿è¾¼ã‚“ã§ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„
                </div>
                <div
                    class="sort-controls"
                    id="sortControls"
                    style="display: none"
                >
                    <label>ä¸¦ã³é †ï¼ˆå•†å“æ•°ï¼‰:</label>
                    <button
                        class="sort-btn active"
                        id="sortAsc"
                        onclick="setSortOrder('asc')"
                    >
                        â–² å°‘ãªã„é †
                    </button>
                    <button
                        class="sort-btn"
                        id="sortDesc"
                        onclick="setSortOrder('desc')"
                    >
                        â–¼ å¤šã„é †
                    </button>
                </div>
                <div class="result-list" id="resultList"></div>
            </div>
        </div>

        <script>
            /* ==============================================
   è¨­å®š
   ============================================== */
            const CSV_DIR = "./csv/";
            const CSV_INDEX = CSV_DIR + "index.json";
            const MAX_RESULTS = 5000;

            /* ==============================================
   ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
   ============================================== */
            let categories = [];
            let currentResults = [];
            let currentSort = "asc";

            /* ==============================================
   DOM
   ============================================== */
            const dropZone = document.getElementById("dropZone");
            const dirInput = document.getElementById("dirInput");
            const fileInput = document.getElementById("fileInput");
            const encodingSel = document.getElementById("encoding");
            const loadMsg = document.getElementById("loadMsg");
            const categoryListEl = document.getElementById("categoryList");
            const noDataEl = document.getElementById("noData");
            const cbActionsEl = document.getElementById("cbActions");
            const summaryEl = document.getElementById("productSummary");
            const serverBanner = document.getElementById("serverBanner");
            const sortControlsEl = document.getElementById("sortControls");

            /* ==============================================
   ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
   ============================================== */
            window.addEventListener("DOMContentLoaded", () => {
                renderCategories();
                loadFromServer();
            });

            /* ==============================================
   ã‚µãƒ¼ãƒãƒ¼CSVè‡ªå‹•èª­ã¿è¾¼ã¿
   ============================================== */
            async function loadFromServer() {
                serverBanner.style.display = "flex";
                serverBanner.className = "server-banner loading";
                serverBanner.innerHTML =
                    '<div class="mini-spinner"></div> ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
                try {
                    const res = await fetch(CSV_INDEX);
                    if (!res.ok) throw new Error(`index.json: ${res.status}`);
                    const fileList = await res.json();
                    if (!Array.isArray(fileList) || !fileList.length)
                        throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒç©ºã§ã™");
                    let ok = 0,
                        ng = 0;
                    for (const fileName of fileList) {
                        try {
                            const csvRes = await fetch(
                                CSV_DIR + encodeURIComponent(fileName),
                            );
                            if (!csvRes.ok) {
                                ng++;
                                continue;
                            }
                            const text = await csvRes.text();
                            const catName = fileName.replace(/\.csv$/i, "");
                            const products = parseCSV(text);
                            if (!products.length) {
                                ng++;
                                continue;
                            }
                            const idx = categories.findIndex(
                                (c) => c.name === catName,
                            );
                            const cat = buildCategory(catName, products);
                            idx >= 0
                                ? (categories[idx] = cat)
                                : categories.push(cat);
                            ok++;
                        } catch {
                            ng++;
                        }
                    }
                    serverBanner.className = "server-banner success";
                    serverBanner.innerHTML =
                        `âœ… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ ${ok} ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†` +
                        (ng ? ` ï¼ˆ${ng}ä»¶ã‚¹ã‚­ãƒƒãƒ—ï¼‰` : "");
                    renderCategories();
                } catch (e) {
                    serverBanner.className = "server-banner fail";
                    serverBanner.innerHTML = `âš  ã‚µãƒ¼ãƒãƒ¼èª­ã¿è¾¼ã¿ä¸å¯ï¼ˆ${e.message}ï¼‰â€” æ‰‹å‹•ã§CSVã‚’è¿½åŠ ã™ã‚‹ã‹ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãŠä½¿ã„ãã ã•ã„`;
                }
            }
            async function reloadFromServer() {
                categories = [];
                renderCategories();
                await loadFromServer();
            }

            /* ==============================================
   ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
   ============================================== */
            dirInput.addEventListener("change", (e) => {
                const files = [...e.target.files].filter((f) =>
                    f.name.toLowerCase().endsWith(".csv"),
                );
                files.length
                    ? processLocalFiles(files)
                    : (loadMsg.textContent =
                          "âš  CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                dirInput.value = "";
            });
            fileInput.addEventListener("change", (e) => {
                if (e.target.files.length)
                    processLocalFiles([...e.target.files]);
                fileInput.value = "";
            });

            dropZone.addEventListener("dragover", (e) => {
                e.preventDefault();
                dropZone.classList.add("drag-over");
            });
            dropZone.addEventListener("dragleave", () =>
                dropZone.classList.remove("drag-over"),
            );
            dropZone.addEventListener("drop", async (e) => {
                e.preventDefault();
                dropZone.classList.remove("drag-over");
                const collected = [];
                const entries = [...(e.dataTransfer.items || [])]
                    .map((i) =>
                        i.webkitGetAsEntry ? i.webkitGetAsEntry() : null,
                    )
                    .filter(Boolean);
                if (entries.length) {
                    for (const en of entries) await collectCSV(en, collected);
                } else
                    [...e.dataTransfer.files].forEach((f) => {
                        if (f.name.toLowerCase().endsWith(".csv"))
                            collected.push(f);
                    });
                collected.length
                    ? processLocalFiles(collected)
                    : (loadMsg.textContent =
                          "âš  CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            });

            function collectCSV(entry, files) {
                return new Promise((resolve) => {
                    if (entry.isFile) {
                        entry.file((f) => {
                            if (f.name.toLowerCase().endsWith(".csv"))
                                files.push(f);
                            resolve();
                        });
                    } else if (entry.isDirectory) {
                        entry.createReader().readEntries(async (entries) => {
                            for (const e of entries) await collectCSV(e, files);
                            resolve();
                        });
                    } else resolve();
                });
            }

            async function processLocalFiles(files) {
                const enc = encodingSel.value;
                let ok = 0,
                    ng = 0;
                for (const file of files) {
                    try {
                        const text = await readLocalText(file, enc);
                        const catName = file.name.replace(/\.csv$/i, "");
                        const products = parseCSV(text);
                        if (!products.length) {
                            ng++;
                            continue;
                        }
                        const idx = categories.findIndex(
                            (c) => c.name === catName,
                        );
                        const cat = buildCategory(catName, products);
                        idx >= 0
                            ? (categories[idx] = cat)
                            : categories.push(cat);
                        ok++;
                    } catch {
                        ng++;
                    }
                }
                loadMsg.textContent =
                    `âœ… ${ok}ä»¶èª­ã¿è¾¼ã¿` + (ng ? ` ï¼ˆ${ng}ä»¶ã‚¹ã‚­ãƒƒãƒ—ï¼‰` : "");
                renderCategories();
            }

            function readLocalText(file, enc) {
                return new Promise((res, rej) => {
                    const r = new FileReader();
                    r.onload = () => res(r.result);
                    r.onerror = () => rej(r.error);
                    r.readAsText(file, enc);
                });
            }

            /* ==============================================
   CSV ãƒ‘ãƒ¼ã‚¹  â˜…3åˆ—ç›®å¯¾å¿œ
   ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: å•†å“å, é‡‘é¡, æœ‰åŠ¹ãƒ•ãƒ©ã‚°(1/0)
   3åˆ—ç›®çœç•¥æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ‰åŠ¹(1)
   ============================================== */
            function parseCSV(text) {
                if (text.charCodeAt(0) === 0xfeff) text = text.slice(1);
                const out = [];
                for (const raw of text.split(/\r?\n/)) {
                    const line = raw.trim();
                    if (!line) continue;
                    const parts = splitCSV(line);
                    if (parts.length < 2) continue;
                    const name = parts[0].trim();
                    const price = parseInt(parts[1].trim(), 10);
                    if (!name || isNaN(price) || price <= 0) continue;

                    // â˜… 3åˆ—ç›®: 1=æœ‰åŠ¹, 0=ç„¡åŠ¹, çœç•¥=æœ‰åŠ¹
                    let enabled = true;
                    if (parts.length >= 3) {
                        const flag = parts[2].trim();
                        if (flag === "0") enabled = false;
                    }

                    out.push({ name, price, checked: enabled });
                }
                return out;
            }

            function splitCSV(line) {
                const r = [];
                let cur = "",
                    q = false;
                for (let i = 0; i < line.length; i++) {
                    const c = line[i];
                    if (q) {
                        if (c === '"') {
                            if (line[i + 1] === '"') {
                                cur += '"';
                                i++;
                            } else q = false;
                        } else cur += c;
                    } else {
                        if (c === '"') q = true;
                        else if (c === ",") {
                            r.push(cur);
                            cur = "";
                        } else cur += c;
                    }
                }
                r.push(cur);
                return r;
            }

            /* ==============================================
   ã‚«ãƒ†ã‚´ãƒªç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
   å•†å“ã® checked çŠ¶æ…‹ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã® checked ã‚’è‡ªå‹•åˆ¤å®š
   ============================================== */
            function buildCategory(name, products) {
                const allChecked = products.every((p) => p.checked);
                return {
                    name,
                    checked: allChecked,
                    expanded: true,
                    products: products, // checked ã¯ parseCSV ã§è¨­å®šæ¸ˆã¿
                };
            }

            /* ==============================================
   ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆ3åˆ—ç›®ç›¸å½“ã® checked ä»˜ãï¼‰
   ============================================== */
            function loadSampleData() {
                categories = [
                    {
                        name: "ãŠã«ãã‚Š",
                        checked: true,
                        expanded: true,
                        products: [
                            { name: "é®­ãŠã«ãã‚Š", price: 130, checked: true },
                            { name: "æ¢…ãŠã«ãã‚Š", price: 120, checked: true },
                            {
                                name: "ãƒ„ãƒŠãƒãƒ¨ãŠã«ãã‚Š",
                                price: 140,
                                checked: true,
                            },
                            {
                                name: "æ˜†å¸ƒãŠã«ãã‚Š",
                                price: 120,
                                checked: false,
                            }, // 0ç›¸å½“
                            {
                                name: "æ˜å¤ªå­ãŠã«ãã‚Š",
                                price: 150,
                                checked: true,
                            },
                        ],
                    },
                    {
                        name: "ãŠå¼å½“",
                        checked: true,
                        expanded: true,
                        products: [
                            { name: "å¹•ã®å†…å¼å½“", price: 498, checked: true },
                            { name: "ã‚«ãƒ„ä¸¼å¼å½“", price: 530, checked: true },
                            { name: "ã®ã‚Šå¼å½“", price: 398, checked: true },
                            { name: "ç„¼è‚‰å¼å½“", price: 580, checked: false },
                        ],
                    }, // 0ç›¸å½“
                    {
                        name: "ãƒ‘ãƒ³ãƒ»ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ",
                        checked: true,
                        expanded: true,
                        products: [
                            { name: "ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ", price: 298, checked: true },
                            { name: "ãŸã¾ã”ã‚µãƒ³ãƒ‰", price: 248, checked: true },
                            { name: "ãƒ¡ãƒ­ãƒ³ãƒ‘ãƒ³", price: 140, checked: true },
                            { name: "ã‚«ãƒ¬ãƒ¼ãƒ‘ãƒ³", price: 160, checked: true },
                        ],
                    },
                    {
                        name: "éººé¡",
                        checked: true,
                        expanded: true,
                        products: [
                            {
                                name: "ã‚«ãƒƒãƒ—éºº(é†¤æ²¹)",
                                price: 198,
                                checked: true,
                            },
                            {
                                name: "ã‚«ãƒƒãƒ—éºº(å‘³å™Œ)",
                                price: 220,
                                checked: true,
                            },
                            {
                                name: "ã‚«ãƒƒãƒ—ç„¼ããã°",
                                price: 210,
                                checked: true,
                            },
                        ],
                    },
                    {
                        name: "ãƒ‰ãƒªãƒ³ã‚¯",
                        checked: true,
                        expanded: true,
                        products: [
                            { name: "ã‚³ãƒ¼ãƒ©500ml", price: 160, checked: true },
                            { name: "ãŠèŒ¶500ml", price: 130, checked: true },
                            { name: "æ°´500ml", price: 100, checked: true },
                            { name: "ã‚³ãƒ¼ãƒ’ãƒ¼ç¼¶", price: 130, checked: true },
                            {
                                name: "ã‚¨ãƒŠã‚¸ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯",
                                price: 210,
                                checked: true,
                            },
                            {
                                name: "ã‚ªãƒ¬ãƒ³ã‚¸ã‚¸ãƒ¥ãƒ¼ã‚¹",
                                price: 150,
                                checked: true,
                            },
                            { name: "ç‰›ä¹³200ml", price: 110, checked: true },
                        ],
                    },
                    {
                        name: "ãŠè“å­",
                        checked: true,
                        expanded: true,
                        products: [
                            {
                                name: "ãƒãƒ†ãƒˆãƒãƒƒãƒ—ã‚¹",
                                price: 168,
                                checked: true,
                            },
                            { name: "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ", price: 198, checked: true },
                            { name: "ã‚¬ãƒ ", price: 128, checked: true },
                            { name: "ã‚­ãƒ£ãƒ³ãƒ‡ã‚£", price: 98, checked: true },
                            { name: "ã‚°ãƒŸ", price: 148, checked: true },
                            { name: "ãƒ“ã‚¹ã‚±ãƒƒãƒˆ", price: 178, checked: true },
                        ],
                    },
                    {
                        name: "ãƒ›ãƒƒãƒˆã‚¹ãƒŠãƒƒã‚¯",
                        checked: true,
                        expanded: true,
                        products: [
                            { name: "è‚‰ã¾ã‚“", price: 150, checked: true },
                            { name: "ã‚ã‚“ã¾ã‚“", price: 140, checked: true },
                            {
                                name: "ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ",
                                price: 180,
                                checked: true,
                            },
                            { name: "ã‹ã‚‰ã‚ã’æ£’", price: 170, checked: true },
                        ],
                    },
                    {
                        name: "ãŠã§ã‚“",
                        checked: true,
                        expanded: true,
                        products: [
                            { name: "ãŠã§ã‚“(å¤§æ ¹)", price: 90, checked: true },
                            {
                                name: "ãŠã§ã‚“(ãŸã¾ã”)",
                                price: 100,
                                checked: true,
                            },
                            {
                                name: "ãŠã§ã‚“(ã¡ãã‚)",
                                price: 80,
                                checked: true,
                            },
                        ],
                    },
                    {
                        name: "ãƒ‡ã‚¶ãƒ¼ãƒˆãƒ»ãã®ä»–",
                        checked: true,
                        expanded: true,
                        products: [
                            {
                                name: "ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ",
                                price: 250,
                                checked: true,
                            },
                            { name: "ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", price: 138, checked: true },
                            { name: "ãƒãƒŠãƒŠ", price: 120, checked: true },
                            { name: "ã‚µãƒ©ãƒ€", price: 268, checked: true },
                            { name: "ãƒ—ãƒªãƒ³", price: 188, checked: true },
                        ],
                    },
                ];
                // ã‚«ãƒ†ã‚´ãƒªã® checked ã‚’å•†å“çŠ¶æ…‹ã‹ã‚‰å†è¨ˆç®—
                categories.forEach(
                    (c) => (c.checked = c.products.every((p) => p.checked)),
                );
                loadMsg.textContent = "ğŸ’¡ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚";
                renderCategories();
            }

            /* ==============================================
   ãƒ‡ãƒ¼ã‚¿æ“ä½œ
   ============================================== */
            function clearAllData() {
                categories = [];
                loadMsg.textContent = "";
                renderCategories();
            }
            function selectAll(v) {
                categories.forEach((c) => {
                    c.checked = v;
                    c.products.forEach((p) => (p.checked = v));
                });
                renderCategories();
            }
            function toggleExpandAll(v) {
                categories.forEach((c) => (c.expanded = v));
                renderCategories();
            }

            /* ==============================================
   ã‚«ãƒ†ã‚´ãƒªæç”»
   ============================================== */
            function renderCategories() {
                categoryListEl
                    .querySelectorAll(".category-panel")
                    .forEach((p) => p.remove());
                if (!categories.length) {
                    noDataEl.style.display = "block";
                    cbActionsEl.style.display = "none";
                    summaryEl.textContent = "";
                    return;
                }
                noDataEl.style.display = "none";
                cbActionsEl.style.display = "flex";
                let total = 0,
                    checked = 0;
                categories.forEach((c) => {
                    total += c.products.length;
                    checked += c.products.filter((p) => p.checked).length;
                });
                summaryEl.textContent = `${categories.length} ã‚«ãƒ†ã‚´ãƒª ï¼ ${total} å“ä¸­ ${checked} å“ã‚’é¸æŠä¸­`;

                categories.forEach((cat, ci) => {
                    const panel = document.createElement("div");
                    panel.className = "category-panel";
                    const hdr = document.createElement("div");
                    hdr.className = "category-header";
                    const cb = document.createElement("input");
                    cb.type = "checkbox";
                    cb.className = "cat-cb";
                    const allC = cat.products.every((p) => p.checked),
                        noneC = cat.products.every((p) => !p.checked);
                    cb.checked = allC;
                    cb.indeterminate = !allC && !noneC;
                    cb.addEventListener("click", (e) => e.stopPropagation());
                    cb.addEventListener("change", (e) => {
                        e.stopPropagation();
                        toggleCategory(ci);
                    });
                    const nm = document.createElement("span");
                    nm.className = "cat-name";
                    nm.textContent = cat.name;
                    const cnt = document.createElement("span");
                    cnt.className = "cat-count";
                    cnt.textContent = `(${cat.products.filter((p) => p.checked).length}/${cat.products.length}å“)`;
                    const tgl = document.createElement("span");
                    tgl.className =
                        "cat-toggle" + (cat.expanded ? " open" : "");
                    tgl.textContent = "â–¼";
                    hdr.append(cb, nm, cnt, tgl);
                    hdr.addEventListener("click", () => {
                        cat.expanded = !cat.expanded;
                        renderCategories();
                    });

                    const body = document.createElement("div");
                    body.className =
                        "category-body" + (cat.expanded ? " expanded" : "");
                    cat.products.forEach((prod, pi) => {
                        const row = document.createElement("div");
                        row.className = "product-row";
                        const pcb = document.createElement("input");
                        pcb.type = "checkbox";
                        pcb.checked = prod.checked;
                        pcb.addEventListener("change", () =>
                            toggleProduct(ci, pi),
                        );
                        const pn = document.createElement("span");
                        pn.className = "prod-name";
                        pn.textContent = prod.name;
                        const pp = document.createElement("span");
                        pp.className = "prod-price";
                        pp.textContent = `Â¥${prod.price.toLocaleString()}`;
                        row.append(pcb, pn, pp);
                        body.appendChild(row);
                    });
                    panel.append(hdr, body);
                    categoryListEl.appendChild(panel);
                });
            }

            function toggleCategory(ci) {
                const c = categories[ci];
                const next = !c.products.every((p) => p.checked);
                c.checked = next;
                c.products.forEach((p) => (p.checked = next));
                renderCategories();
            }
            function toggleProduct(ci, pi) {
                const c = categories[ci];
                c.products[pi].checked = !c.products[pi].checked;
                c.checked = c.products.every((p) => p.checked);
                renderCategories();
            }

            function getCheckedProducts() {
                const out = [];
                categories.forEach((c) =>
                    c.products.forEach((p) => {
                        if (p.checked)
                            out.push({ name: p.name, price: p.price });
                    }),
                );
                return out;
            }

            /* ==============================================
   ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   ============================================== */
            function validate() {
                const errEl = document.getElementById("errMsg");
                errEl.textContent = "";
                const raw = document.getElementById("target").value.trim();
                if (!raw) {
                    errEl.textContent = "âš  ç›®æ¨™é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                    return null;
                }
                const v = Number(raw);
                if (!Number.isInteger(v) || v <= 0) {
                    errEl.textContent = "âš  æ­£ã®æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                    return null;
                }
                const products = getCheckedProducts();
                if (!products.length) {
                    errEl.textContent = "âš  å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                    return null;
                }
                return { target: v, products };
            }

            function setStatus(type, html) {
                const bar = document.getElementById("statusBar");
                bar.className = "status-bar " + type;
                bar.innerHTML = html;
            }

            /* ==============================================
   çµ„ã¿åˆã‚ã›æ¢ç´¢ (DFS)
   ============================================== */
            function findCombinations(items, target) {
                const sorted = items.slice().sort((a, b) => a.price - b.price);
                const results = [];
                let limitHit = false;
                function dfs(idx, rem, cur) {
                    if (limitHit) return;
                    if (rem === 0) {
                        results.push(cur.slice());
                        if (results.length >= MAX_RESULTS) limitHit = true;
                        return;
                    }
                    for (let i = idx; i < sorted.length; i++) {
                        if (sorted[i].price > rem) break;
                        cur.push(sorted[i]);
                        dfs(i, rem - sorted[i].price, cur);
                        if (limitHit) return;
                        cur.pop();
                    }
                }
                dfs(0, target, []);
                return { results, limitHit };
            }

            function comboItemCount(combo) {
                return combo.length;
            }

            function formatCombo(combo) {
                const m = new Map();
                combo.forEach((p) => m.set(p.name, (m.get(p.name) || 0) + 1));
                return [...m].map(([n, c]) => `${n}Ã—${c}`).join(", ");
            }

            /* ==============================================
   ã‚½ãƒ¼ãƒˆ & çµæœæç”»
   ============================================== */
            function setSortOrder(order) {
                currentSort = order;
                document
                    .getElementById("sortAsc")
                    .classList.toggle("active", order === "asc");
                document
                    .getElementById("sortDesc")
                    .classList.toggle("active", order === "desc");
                renderResults();
            }

            function renderResults() {
                const listEl = document.getElementById("resultList");
                listEl.innerHTML = "";
                if (!currentResults.length) return;
                const sorted = currentResults.slice().sort((a, b) => {
                    const diff = comboItemCount(a) - comboItemCount(b);
                    return currentSort === "asc" ? diff : -diff;
                });
                const frag = document.createDocumentFragment();
                sorted.forEach((combo, i) => {
                    const count = comboItemCount(combo);
                    const d = document.createElement("div");
                    d.className = "result-item";
                    d.innerHTML =
                        `<span class="idx">#${i + 1}</span>` +
                        `<span class="combo-detail">${formatCombo(combo)}</span>` +
                        `<span class="item-count">è¨ˆ${count}å€‹</span>`;
                    frag.appendChild(d);
                });
                listEl.appendChild(frag);
            }

            /* ==============================================
   ãƒ¡ã‚¤ãƒ³æ¤œç´¢
   ============================================== */
            function startSearch() {
                const v = validate();
                if (!v) return;
                const btn = document.getElementById("btnCalc");
                currentResults = [];
                sortControlsEl.style.display = "none";
                document.getElementById("resultList").innerHTML = "";
                btn.disabled = true;
                setStatus("running", '<div class="spinner"></div> è¨ˆç®—ä¸­â€¦');

                setTimeout(() => {
                    const t0 = performance.now();
                    const { results, limitHit } = findCombinations(
                        v.products,
                        v.target,
                    );
                    const ms = (performance.now() - t0).toFixed(1);
                    currentResults = results;

                    if (!results.length) {
                        setStatus(
                            "idle",
                            `è©²å½“ã™ã‚‹çµ„ã¿åˆã‚ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆ${ms}msï¼‰`,
                        );
                    } else if (limitHit) {
                        setStatus(
                            "warn",
                            `âš  ${MAX_RESULTS.toLocaleString()}ä»¶ã§æ¢ç´¢ã‚’ä¸­æ–­ã—ã¾ã—ãŸï¼ˆ${ms}msï¼‰`,
                        );
                    } else {
                        setStatus(
                            "done",
                            `âœ… <strong>${results.length.toLocaleString()}ä»¶</strong>ã®çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆ${ms}msï¼‰`,
                        );
                    }

                    if (results.length) {
                        sortControlsEl.style.display = "flex";
                        currentSort = "asc";
                        document
                            .getElementById("sortAsc")
                            .classList.add("active");
                        document
                            .getElementById("sortDesc")
                            .classList.remove("active");
                        renderResults();
                    }
                    btn.disabled = false;
                }, 50);
            }

            document
                .getElementById("target")
                .addEventListener("keydown", (e) => {
                    if (e.key === "Enter") startSearch();
                });
        </script>
    </body>
</html>
