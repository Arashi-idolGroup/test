<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSVèª­ã¿è¾¼ã¿ãƒ»å•†å“çµ„ã¿åˆã‚ã›æ¤œç´¢</title>
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: "Segoe UI", "Hiragino Sans", sans-serif;
                background: #f0f2f5;
                color: #333;
                min-height: 100vh;
            }

            /* ===== header ===== */
            .header {
                background: linear-gradient(135deg, #2c3e50, #4ca1af);
                color: #fff;
                padding: 20px;
                text-align: center;
            }
            .header h1 {
                font-size: 1.5rem;
                letter-spacing: 0.05em;
            }
            .header p {
                margin-top: 5px;
                font-size: 0.85rem;
                opacity: 0.9;
            }

            /* ===== main ===== */
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
            }

            /* ===== card ===== */
            .card {
                background: #fff;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
                padding: 20px;
                margin-bottom: 20px;
            }
            .card h2 {
                font-size: 1.1rem;
                margin-bottom: 15px;
                padding-bottom: 8px;
                border-bottom: 2px solid #4ca1af;
                color: #2c3e50;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            /* ===== File Input ===== */
            .file-area {
                border: 2px dashed #ccc;
                padding: 20px;
                text-align: center;
                border-radius: 8px;
                background: #fafafa;
                transition: 0.2s;
            }
            .file-area:hover {
                background: #f0f8ff;
                border-color: #4ca1af;
            }
            .file-area input[type="file"] {
                display: none;
            }
            .file-label {
                cursor: pointer;
                display: inline-block;
                padding: 10px 20px;
                background: #4ca1af;
                color: #fff;
                border-radius: 5px;
                font-weight: bold;
            }
            .file-msg {
                display: block;
                margin-top: 10px;
                font-size: 0.9rem;
                color: #666;
            }

            /* ===== Product List (Categories) ===== */
            .category-group {
                margin-bottom: 15px;
                border: 1px solid #eee;
                border-radius: 6px;
                overflow: hidden;
            }
            .cat-header {
                background: #eef2f5;
                padding: 8px 12px;
                font-weight: bold;
                display: flex;
                align-items: center;
                cursor: pointer;
                user-select: none;
            }
            .cat-header:hover {
                background: #e0e6ed;
            }
            .cat-header input {
                margin-right: 8px;
                transform: scale(1.2);
                cursor: pointer;
            }

            .cat-items {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 5px;
                padding: 10px;
                background: #fff;
            }

            .item-row {
                display: flex;
                align-items: center;
                font-size: 0.9rem;
                padding: 5px;
                border-radius: 4px;
                transition: 0.1s;
            }
            .item-row:hover {
                background: #f5f5f5;
            }
            .item-row input {
                margin-right: 8px;
                cursor: pointer;
            }
            .item-row.inactive {
                opacity: 0.5;
                text-decoration: line-through;
            }
            .price-tag {
                margin-left: auto;
                color: #d35400;
                font-weight: bold;
            }

            /* ===== Input & Button ===== */
            .ctrl-row {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            .ctrl-row input[type="number"] {
                padding: 8px;
                font-size: 1rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: 150px;
            }
            .btn-calc {
                padding: 10px 24px;
                background: #e67e22;
                color: #fff;
                border: none;
                border-radius: 4px;
                font-weight: bold;
                cursor: pointer;
                font-size: 1rem;
            }
            .btn-calc:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn-calc:hover:not(:disabled) {
                background: #d35400;
            }

            /* ===== Result ===== */
            .status-bar {
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
                margin-bottom: 10px;
                font-weight: bold;
                font-size: 0.9rem;
            }
            .result-list {
                max-height: 400px;
                overflow-y: auto;
                border-top: 1px solid #eee;
            }
            .result-item {
                padding: 8px 10px;
                border-bottom: 1px solid #eee;
                font-size: 0.9rem;
            }
            .idx {
                background: #2c3e50;
                color: #fff;
                padding: 1px 6px;
                border-radius: 3px;
                font-size: 0.8rem;
                margin-right: 5px;
            }

            /* Spinner */
            .spinner {
                display: inline-block;
                width: 12px;
                height: 12px;
                border: 2px solid #333;
                border-top-color: transparent;
                border-radius: 50%;
                animation: spin 0.6s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ğŸ“‚ CSV å•†å“çµ„ã¿åˆã‚ã›ç®—å‡º</h1>
            <p>
                è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€é¸æŠã—ãŸå•†å“ã§ç›®æ¨™é‡‘é¡ã‚’æ¢ç´¢ã—ã¾ã™
            </p>
        </div>

        <div class="container">
            <!-- STEP 1: CSVèª­ã¿è¾¼ã¿ -->
            <div class="card">
                <h2>1. å•†å“ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ (CSV)</h2>
                <div class="file-area">
                    <label class="file-label">
                        ğŸ“‚ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (è¤‡æ•°å¯)
                        <input
                            type="file"
                            id="csvFiles"
                            multiple
                            accept=".csv"
                            onchange="handleFiles(this.files)"
                        />
                    </label>
                    <span class="file-msg" id="fileMsg"
                        >â€»CSVå½¢å¼: ã€Œå•†å“å, é‡‘é¡ã€ (ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—æƒ³å®š)</span
                    >
                </div>
            </div>

            <!-- STEP 2: å•†å“é¸æŠãƒªã‚¹ãƒˆ -->
            <div class="card">
                <h2>
                    2. è¨ˆç®—å¯¾è±¡ã®é¸æŠ
                    <small style="font-size: 0.8rem; font-weight: normal">
                        (é¸æŠä¸­: <span id="selectedCount">0</span>å“)
                    </small>
                </h2>
                <div id="productListArea">
                    <div style="color: #777; padding: 10px">
                        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã“ã“ã«ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>
            </div>

            <!-- STEP 3: è¨ˆç®— -->
            <div class="card">
                <h2>3. æ¤œç´¢å®Ÿè¡Œ</h2>
                <div class="ctrl-row">
                    <label
                        >ç›®æ¨™é‡‘é¡:
                        <input
                            type="number"
                            id="targetPrice"
                            value="1000"
                            min="1"
                    /></label>
                    <button
                        class="btn-calc"
                        id="btnCalc"
                        onclick="startSearch()"
                        disabled
                    >
                        è¨ˆç®—ã™ã‚‹
                    </button>
                </div>
                <div style="margin-top: 10px" id="statusBar"></div>
                <div class="result-list" id="resultList"></div>
            </div>
        </div>

        <script>
            /**
             * ãƒ‡ãƒ¼ã‚¿æ§‹é€ :
             * categories = {
             *   "ãŠè“å­.csv": [ { name:"ãƒãƒ§ã‚³", price:100, active:true }, ... ],
             *   "é£²ã¿ç‰©.csv": [ ... ]
             * }
             */
            let CATEGORIES = {};
            const MAX_RESULTS = 5000;

            // =============================================
            // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†
            // =============================================
            async function handleFiles(files) {
                if (!files.length) return;

                CATEGORIES = {}; // ãƒªã‚»ãƒƒãƒˆ
                const msgEl = document.getElementById("fileMsg");
                msgEl.textContent = `â³ ${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...`;

                let totalItems = 0;

                for (const file of files) {
                    try {
                        const text = await readFileAsText(file);
                        const items = parseCSV(text);
                        if (items.length > 0) {
                            CATEGORIES[file.name] = items;
                            totalItems += items.length;
                        }
                    } catch (e) {
                        console.error(`Error reading ${file.name}:`, e);
                    }
                }

                msgEl.textContent = `âœ… èª­ã¿è¾¼ã¿å®Œäº†: ${Object.keys(CATEGORIES).length}ãƒ•ã‚¡ã‚¤ãƒ«, åˆè¨ˆ${totalItems}å•†å“`;
                renderProductList();
                updateSelectionState();
            }

            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    // æ—¥æœ¬èªCSVå¯¾ç­–ã§Shift_JISã‹UTF-8ã‹åˆ¤å®šã—ãŸã„ãŒã€ä»Šå›ã¯UTF-8å‰æã¨ã™ã‚‹
                    reader.readAsText(file);
                });
            }

            function parseCSV(text) {
                const lines = text.split(/\r\n|\n/);
                const items = [];

                lines.forEach((line) => {
                    // ç©ºè¡Œã‚„ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã®ã‚¹ã‚­ãƒƒãƒ—
                    if (!line.trim()) return;

                    // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š (å•†å“å, é‡‘é¡)
                    const cols = line.split(",");
                    if (cols.length < 2) return;

                    const name = cols[0].trim();
                    const priceRaw = cols[1].trim();
                    const price = parseInt(priceRaw, 10);

                    // é‡‘é¡ãŒæ•°å€¤ã¨ã—ã¦æœ‰åŠ¹ãªã‚‰ç™»éŒ²
                    if (name && !isNaN(price) && price > 0) {
                        items.push({
                            name: name,
                            price: price,
                            active: true, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨ˆç®—å¯¾è±¡ã«ã™ã‚‹
                        });
                    }
                });
                return items;
            }

            // =============================================
            // 2. ãƒªã‚¹ãƒˆæç”» & ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ¶å¾¡
            // =============================================
            function renderProductList() {
                const container = document.getElementById("productListArea");
                container.innerHTML = "";

                const filenames = Object.keys(CATEGORIES).sort();
                if (filenames.length === 0) {
                    container.innerHTML =
                        '<div style="color:red;">æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
                    return;
                }

                filenames.forEach((fname) => {
                    const items = CATEGORIES[fname];

                    // ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ³ãƒ†ãƒŠ
                    const groupDiv = document.createElement("div");
                    groupDiv.className = "category-group";

                    // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰
                    const header = document.createElement("div");
                    header.className = "cat-header";
                    header.innerHTML = `
      <label style="display:flex; align-items:center; cursor:pointer; width:100%;">
        <input type="checkbox" checked onchange="toggleCategory('${fname}', this.checked)">
        ğŸ“‚ ${fname} (${items.length}å“)
      </label>
    `;
                    groupDiv.appendChild(header);

                    // ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ
                    const listDiv = document.createElement("div");
                    listDiv.className = "cat-items";
                    listDiv.id = `list-${fname}`;

                    items.forEach((item, idx) => {
                        const row = document.createElement("div");
                        row.className = "item-row";
                        row.innerHTML = `
        <label style="display:flex; align-items:center; width:100%; cursor:pointer;">
          <input type="checkbox" checked
            onchange="toggleItem('${fname}', ${idx}, this.checked)">
          <span>${item.name}</span>
          <span class="price-tag">Â¥${item.price}</span>
        </label>
      `;
                        listDiv.appendChild(row);
                    });

                    groupDiv.appendChild(listDiv);
                    container.appendChild(groupDiv);
                });

                document.getElementById("btnCalc").disabled = false;
            }

            // ã‚«ãƒ†ã‚´ãƒªä¸€æ‹¬åˆ‡æ›¿
            window.toggleCategory = function (filename, isChecked) {
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                CATEGORIES[filename].forEach(
                    (item) => (item.active = isChecked),
                );

                // è¡¨ç¤ºï¼ˆå­è¦ç´ ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰ã‚’æ›´æ–°
                const listDiv = document.getElementById(`list-${filename}`);
                const inputs = listDiv.querySelectorAll("input[type=checkbox]");
                inputs.forEach((input) => (input.checked = isChecked));

                // è¦‹ãŸç›®ã®éæ´»æ€§ã‚¹ã‚¿ã‚¤ãƒ«
                updateRowStyles(listDiv, isChecked);
                updateSelectionState();
            };

            // å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ åˆ‡æ›¿
            window.toggleItem = function (filename, index, isChecked) {
                CATEGORIES[filename][index].active = isChecked;
                updateSelectionState();

                // è¦ªã‚«ãƒ†ã‚´ãƒªã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹é€£å‹•ï¼ˆç°¡æ˜“å®Ÿè£…: å…¨ã¦OFFãªã‚‰è¦ªã‚‚OFFã«ã™ã‚‹ç­‰ã¯çœç•¥ï¼‰
            };

            function updateRowStyles(container, active) {
                const rows = container.querySelectorAll(".item-row");
                rows.forEach((r) => {
                    if (active) r.classList.remove("inactive");
                    else r.classList.add("inactive");
                });
            }

            function updateSelectionState() {
                let count = 0;
                Object.values(CATEGORIES).forEach((items) => {
                    items.forEach((item) => {
                        if (item.active) count++;
                    });
                });
                document.getElementById("selectedCount").textContent = count;
                document.getElementById("btnCalc").disabled = count === 0;
            }

            // =============================================
            // 3. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
            // =============================================
            function getActiveItems() {
                // å…¨ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰active=trueãªã‚‚ã®ã ã‘æŠ½å‡ºã—ã¦ãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã«ã™ã‚‹
                let flat = [];
                Object.values(CATEGORIES).forEach((items) => {
                    items.forEach((item) => {
                        if (item.active) flat.push(item);
                    });
                });
                return flat;
            }

            function startSearch() {
                const targetInput = document.getElementById("targetPrice");
                const target = parseInt(targetInput.value, 10);
                const statusEl = document.getElementById("statusBar");
                const resultList = document.getElementById("resultList");

                if (isNaN(target) || target <= 0) {
                    alert("ç›®æ¨™é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }

                const items = getActiveItems();
                if (items.length === 0) {
                    alert("è¨ˆç®—å¯¾è±¡ã®å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
                    return;
                }

                // UIãƒªã‚»ãƒƒãƒˆ
                resultList.innerHTML = "";
                statusEl.innerHTML = '<span class="spinner"></span> è¨ˆç®—ä¸­...';
                document.getElementById("btnCalc").disabled = true;

                // UIãƒ–ãƒ­ãƒƒã‚¯å›é¿ã®ãŸã‚setTimeout
                setTimeout(() => {
                    const startTime = performance.now();

                    // è¨ˆç®—å®Ÿè¡Œ
                    const { results, limitReached } = findCombinations(
                        items,
                        target,
                    );

                    const elapsed = (performance.now() - startTime).toFixed(1);

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
                    let msg = "";
                    if (results.length === 0) {
                        msg = `è©²å½“ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã— (${elapsed}ms)`;
                        statusEl.style.color = "#d35400";
                    } else {
                        msg = `<strong>${results.length}ä»¶</strong> è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ (${elapsed}ms)`;
                        if (limitReached)
                            msg += " <small>â€»ä¸Šé™ã«é”ã—ãŸãŸã‚ä¸­æ–­</small>";
                        statusEl.style.color = "#27ae60";
                    }
                    statusEl.innerHTML = msg;

                    // çµæœè¡¨ç¤º
                    const fragment = document.createDocumentFragment();
                    results.forEach((combo, i) => {
                        const div = document.createElement("div");
                        div.className = "result-item";
                        div.innerHTML = `<span class="idx">#${i + 1}</span> ${formatCombo(combo)}`;
                        fragment.appendChild(div);
                    });
                    resultList.appendChild(fragment);

                    document.getElementById("btnCalc").disabled = false;
                }, 50);
            }

            // æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (IDä¸è¦ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‚ç…§ã§å‡¦ç†)
            function findCombinations(items, target) {
                // é‡‘é¡æ˜‡é †ã‚½ãƒ¼ãƒˆï¼ˆæåˆˆã‚ŠåŠ¹ç‡åŒ–ï¼‰
                items.sort((a, b) => a.price - b.price);

                const results = [];
                let limitReached = false;

                function dfs(startIdx, currentSum, currentItems) {
                    if (limitReached) return;

                    if (currentSum === target) {
                        results.push([...currentItems]);
                        if (results.length >= MAX_RESULTS) limitReached = true;
                        return;
                    }

                    if (currentSum > target) return;

                    for (let i = startIdx; i < items.length; i++) {
                        const item = items[i];
                        // æåˆˆã‚Šï¼šä»Šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¶³ã—ã¦ã‚ªãƒ¼ãƒãƒ¼ã™ã‚‹ãªã‚‰ã€ãã‚Œä»¥é™ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ç¢ºå®Ÿã«ã‚ªãƒ¼ãƒãƒ¼
                        if (currentSum + item.price > target) break;

                        currentItems.push(item);
                        // é‡è¤‡è¨±å¯ãªã®ã§ index 'i' ã‚’ãã®ã¾ã¾æ¸¡ã™
                        dfs(i, currentSum + item.price, currentItems);
                        if (limitReached) return;
                        currentItems.pop();
                    }
                }

                dfs(0, 0, []);
                return { results, limitReached };
            }

            function formatCombo(combo) {
                // åå‰ã§é›†è¨ˆ: Map { "å•†å“å" => å€‹æ•° }
                const counts = new Map();
                combo.forEach((p) => {
                    counts.set(p.name, (counts.get(p.name) || 0) + 1);
                });

                // æ–‡å­—åˆ—åŒ–
                const parts = [];
                counts.forEach((count, name) => {
                    parts.push(`${name}Ã—${count}`);
                });
                return parts.join(", ");
            }
        </script>
    </body>
</html>
